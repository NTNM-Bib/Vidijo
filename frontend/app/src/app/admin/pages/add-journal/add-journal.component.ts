import { Component, OnInit, Input } from "@angular/core";
import { FormControl } from "@angular/forms";
import { IJournal } from "src/app/journals/shared/journal.interface";
import { JournalService } from "src/app/journals/shared/journal.service";
import { AdminService, VidijoData } from "../../shared/admin.service";
import { debounceTime } from "rxjs/operators";
import { ICategory } from "src/app/journals/shared/category.interface";
import { AlertService } from "src/app/core/alert/alert.service";

@Component({
  selector: "app-add-journal",
  templateUrl: "./add-journal.component.html",
  styleUrls: ["./add-journal.component.scss"],
})
export class AddJournalComponent implements OnInit {
  @Input() category: ICategory;

  searchFormControl = new FormControl();
  searchValue: string = "";

  journalResultsInVidijo: IJournal[] = [];
  journalResultsInDOAJ: IJournal[] = [];

  noSearchResults: boolean = true;

  journalsListFile: File;
  info: any = null;

  constructor(
    private journalService: JournalService,
    private adminService: AdminService,
    private alertService: AlertService
  ) {}

  ngOnInit() {
    this.getCategory();

    // Search if value changes
    this.searchFormControl.valueChanges
      .pipe(debounceTime(300))
      .subscribe(async (value) => {
        this.searchValue = value;

        if (value === "") {
          this.journalResultsInVidijo = [];
          this.journalResultsInDOAJ = [];
          this.noSearchResults = false;
          return;
        }

        // Set search term and reset display limits for journals and articles
        this.noSearchResults = false;

        this.search(value).then(() => {
          this.noSearchResults =
            this.journalResultsInVidijo.length < 1 &&
            this.journalResultsInDOAJ.length < 1;
        });
      });
  }

  getCategory() {
    if (!this.category._id) {
      this.category = {
        _id: "all",
        title: "All Journals",
        color: "#ffffff",
      } as ICategory;

      return;
    }

    if (this.category._id === "favorites") {
      this.category = {
        _id: "favorites",
        title: "Favorite Journals",
        color: "#ffffff",
      } as ICategory;

      return;
    }

    this.journalService
      .getCategory(this.category._id)
      .then((category: ICategory) => {
        this.category = category;
      })
      .catch((err) => {});
  }

  search(searchTerm: string): Promise<void> {
    const promise: Promise<void> = new Promise((resolve, reject) => {
      if (this.category._id !== "all") {
        this.journalService
          .getJournals(
            `?search=${searchTerm}&limit=10&sort=+title&categories=!${this.category._id}`
          )
          .subscribe((journalResultsResponse: any) => {
            this.journalResultsInVidijo = journalResultsResponse.docs;
          });
      }

      this.adminService.searchJournalsInDOAJ(searchTerm).subscribe(
        (result) => {
          this.journalResultsInDOAJ = result.availableJournals;
          this.journalResultsInVidijo = result.alreadyExistingJournals;
        },
        (err) => {
          this.alertService.showSnackbarAlert(
            `Something went wrong when searching journals: ${err}`,
            "Okay",
            () => {},
            5000,
            true
          );
        }
      );
    });

    return promise;
  }

  // Journal importer
  onSelect(event) {
    this.journalsListFile = event.addedFiles[0];

    this.adminService.getXLSXInfo(this.journalsListFile).subscribe(
      (info) => {
        this.info = info;
      },
      (err) => {
        console.error(err);
      }
    );
  }

  onRemove() {
    this.journalsListFile = null;
    this.info = null;
  }

  importJournalsList() {
    if (!this.journalsListFile) return;

    this.adminService.uploadXLSX(this.journalsListFile).subscribe(
      (success) => {
        this.alertService.showDialogAlert(
          "Imported Journals",
          "Successfully imported journals",
          "Okay",
          () => {}
        );
      },
      (error) => {
        this.alertService.showSnackbarAlert(
          "Cannot import journals",
          "Okay",
          () => {},
          5000,
          true
        );
      }
    );
  }
}
