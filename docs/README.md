# Vidijo Documentation

This folder contains the documentation for Vidijo. Its purpose is to provide an overview over the project and entrypoints for troubleshooting problems that might arise in the future when third-party dependencies change.

- [Vidijo Documentation](#vidijo-documentation)
  - [General Information](#general-information)
  - [Project Structure](#project-structure)
    - [Project Root](#project-root)
    - [Services](#services)
      - [Source Code](#source-code)
    - [App (Frontend)](#app-frontend)
      - [Example](#example)
  - [Architecture](#architecture)
    - [App (Frontend)](#app-frontend-1)
    - [Services](#services-1)
      - [API Gateway](#api-gateway)
      - [API](#api)
      - [External Data Service](#external-data-service)
      - [Updater Service](#updater-service)
    - [Volumes](#volumes)
      - [MongoDB Volume](#mongodb-volume)
      - [Covers Volume](#covers-volume)
    - [Third-Party Services](#third-party-services)
      - [DOAJ API](#doaj-api)
      - [JournalTOCs Website](#journaltocs-website)
  - [Maintenance](#maintenance)
    - [Updating certificates](#updating-certificates)
    - [Troubleshooting](#troubleshooting)
      - [Downloading Journals and Articles](#downloading-journals-and-articles)
      - [Automatic Cover Download](#automatic-cover-download)
      - [Third-Party Software](#third-party-software)

## General Information

Vidijo is developed with software from the [MEAN Stack][mean]. We use [TypeScript][ts] instead of JavaScript for frontend and backend service development.

The frontend uses [Angular][ng] as a framework and [Angular Material][ng-mat] as its User Interface library.

The backend consists of 3 different services using the [Express][express] framework and 1 reverse proxy (using [NGINX][nginx]). We use a single instance of [MongoDB][mongo] to store the majority of the data.

Each component of Vidijo runs inside their own container using [Docker][docker]. The entire architecture is configured to run inside containers for development and deployment.

More information about the architecture of the project and the interplay between components can be found in the chapter [Architecture](#architecture).
If you want to find out more about the structure of the project and the tasks of important files, continue with the [next chapter](#project-structure) instead.

## Project Structure

This section provides an overview over the folder structure and some important files of the project.

### Project Root

The following folders are present in the root project directory.

| Folder                 | Content                                                                |
| ---------------------- | ---------------------------------------------------------------------- |
| `/backend/`            | contains all [backend services](#services-1)                           |
| `/config/`             | contains the main configuration (created by admin on installation)     |
| `/config.dev/`         | contains the config for development (created by admin on installation) |
| `/config.dev.example/` | contains an example development configuration                          |
| `/config.example/`     | contains an example main configuration                                 |
| `/docs/`               | contains the documentation                                             |
| `/frontend/`           | contains the [frontend application](#app-frontend-1)                   |
| `/images/`             | contains images displayed in the main `README.md`                      |
| `/util/`               | contains utility scripts (e.g. for dependency updates)                 |

### Services

Each backend service (except the [API Gateway](#api-gateway)) is build after the following structure. More information about the API Gateway can be found in the section [Updating Certificates](#updating-certificates).

| Folder / File       | Content / Task                                                                      |
| ------------------- | ----------------------------------------------------------------------------------- |
| `node_modules/`     | contains the third-party library files (created on installation in development)     |
| `src/`              | contains the source code of this service                                            |
| `.dockerignore`     | a file to tell Docker which folders should be ignored                               |
| `.prettierrc`       | a file to enforce consistent formatting in the service (using [Prettier][prettier]) |
| `dev.Dockerfile`    | the [Dockerfile][dockerfile] used in development                                    |
| `Dockerfile`        | the [Dockerfile][dockerfile] used in production                                     |
| `gulpfile.ts`       | a file containing automated tasks using [Gulp][gulp]                                |
| `package-lock.json` | automatically generated by npm (see [here][package-lock])                           |
| `package.json`      | file with _npm_ scripts and metadata about the service (see [here][package])        |
| `tsconfig.json`     | file for setting up the [TypeScript][ts] compiler                                   |

#### Source Code

This is an overview over the `src/` folder inside the backend services (using the API as an example). Some services might contain additional files (e.g. `auth.ts` in the API), but this is an overview over the files and folders that are present in most services.

| Folder / File         | Content / Task                                                                          |
| --------------------- | --------------------------------------------------------------------------------------- |
| `routes/`             | contains the API endpoints (e.g. `GET /journals/:id` in `journal.router.ts`)            |
| `routes/controllers/` | contains the handlers that are invoked when calling an endpoint                         |
| `shared/`             | contains folders and files that are shared between services                             |
| `templates/`          | contains templates for verification and password reset mails                            |
| `*.config.ts`         | contains methods to safely read configuration from environment variables (`.env` files) |
| `app.ts`              | defines the Express App (see [here][express-app] for more information)                  |
| `index.ts`            | the main entry point for the service (sets up the database connection, server and more) |

### App (Frontend)

The structure of the frontend follows the conventions used in [Angular][ng] projects. Only components are organized in a slightly different way.

| Component Sub-Folder | Content                                                                                 |
| -------------------- | --------------------------------------------------------------------------------------- |
| `components/`        | contains the presentation components that can be used inside the pages (e.g. a journal) |
| `pages/`             | contains the pages of this module (e.g. the discover page)                              |
| `shared/`            | contains shared files for this module, like services and interfaces                     |
| `*.module.ts`        | the Angular module file                                                                 |

#### Example

The folder `src/app/journals` is organized in the above mentioned way. The `components/` folder contains a folder `journal-thumbnail/` which contains the logic, styles and markup for representing a journal in the application. This component is used throughout the entire application on different pages like the discover page, home page and more. It is saved under `components/` since we do not use it as an entire page itself, but only embed it inside other pages.

The `pages/` folder inside `src/app/journals` contains the main pages of the application, that can be accessed via different routes. The `discover/` folder - for example - contains the logic, styles and markup to build up the page that is accessible under `https://vidijo.org/discover`. Pages like the discover page use other presentation components from the `components/` folder to populate them with content. The task of the page logic is to fetch data using different services (like `journal.service.ts` in the `shared/` folder) and setting up the presentation components using that data (e.g. the discover page fetches the most read journals and spawns a new `journal-thumbnail` for each journal).

The `shared/` folder inside `src/app/journals` contains interfaces to define custom types and, more importantly, the service to fetch data (`journal.service.ts`). This service connects the app to our API and can change the received data in a way to make it usable in the frontend.

## Architecture

This section provides an overview over the architecture of Vidijo and how the services are connected. You can find more information about each service [below](#services).

![Architecture Overview](images/architecture.png)

The **orange-colored** entities and connections represent everything that is outside of the internal Vidijo network. We've got users on the left that want to access the Vidijo website and we also have our data sources on the right (DOAJ API and JournalTOCs Website). Since the connection to these entities runs over the internet, they are colored in orange.

Everything else is colored in **dark grey** and represents entities that belong to the internal network of Vidijo components. These components are connected via the local [Docker Bridge Network][docker-bridge] which is isolated from the internet. Since this local network is not reachable from outside, we can internally abandon access control for these services. The only exception is the API, which performs user authentication and authorization for incoming requests and delegates tasks to the other internal services.

### App (Frontend)

The code for the frontend application can be found in `/frontend/api`.

This is the frontend for Vidijo - it is written in [TypeScript][ts] using the [Angular][ng] framework.

The frontend gets build inside a temporary container and deployed inside another container using [NGINX][nginx].
It can be accessed by the public via the [API Gateway](#api-gateway) that redirects requests to the app container.

### Services

An overview over the backend services.

#### API Gateway

The code for the API Gateway can be found in `/backend/api-gateway`.

The API Gateway is the only service of Vidijo that is exposed to its users. Thats why it needs valid TLS certificates (updating certificates is described in the chapter [Maintenance](#maintenance)).

Its job is to receive requests and redirect them to the according services.
An example: A user requests `https://vidijo.org/` - the gateway redirects the request to the frontend container and serves the client application.
Another example: The user requests `https://vidijo.org/api/v1/journals` - the gateway redirects the request to the API container and serves the JSON response containing journals.

#### API

The code for the API can be found in `/backend/api`.

The API connects the frontend with the entire backend. It performs user authentication and authorization and can handle tasks on its own like getting queried articles or journals from the database and sending them to the frontend.

Another important task is to receive requests from the client and delegate them to the other backend services. For example: An admin wants to add a new journal to Vidijo: the frontend sends a POST request to the API which delegates the task to the [External Data Service](#external-data-service).

This approach is used to provide a single interface between frontend and backend but also make is possible to separate areas of concern and not slow down the API with resource heavy tasks like fetching new articles from [DOAJ][doaj].

#### External Data Service

The code for this service can be found in `/backend/external-data.service`.

The job of this service is to be the bridge between external services and the Vidijo architecture. Its tasks are the following.

- search journals in [DOAJ][doaj]
- download journals from [DOAJ][doaj] and convert them to our own format
- download articles from [DOAJ][doaj] and convert them to our own format
- try finding a cover for newly added journals using the [JournalTOCs][jt] website
- sanitize incoming data (e.g. by removing HTML tags and duplicate authors)

#### Updater Service

The code for this service can be found in `/backend/updater.service`.

This service runs in the background and updates journals in a set interval (e.g. 1 journal every 10 minutes). It selects the journal that has not been updated for the longest time from our database and sends a command to the [External Data Service](#external-data-service) to fetch the articles of this journal from [DOAJ][doaj].

### Volumes

Volumes are used in Docker to provide persistent data storage. If we did not use volumes, we would lose all of our data when recreating containers. They also provide a way to share data between containers. This is especially useful for the [Covers Volume](#covers-volume).

#### MongoDB Volume

This volume is only mounted into the database container and provides persistent storage for our instance of MongoDB. In MongoDB, we save all journals, articles, users and more; basically everything except covers and the privacy policy.

#### Covers Volume

This volume contains all journal covers. It is used by the [API Gateway](#api-gateway) to make the covers accessible to the application, by the [External Data Service](#external-data-service) as a place to store the automatically downloaded covers and by the [API](#api) as a place to store uploaded covers.

### Third-Party Services

We use [DOAJ][doaj] as our main data source to retrieve journals and articles. Since the [DOAJ] API does not provide journal covers, we use the [JournalTOCs][jt] website for this task instead.

#### DOAJ API

The [DOAJ][doaj] API is only accessed in our [External Data Service](#external-data-service) in `src/collectors/article.collector.ts` and `src/collectors/journal.collector.ts`.

Currently, we use the following API endpoint to fetch the newest articles:

```ts
// Fetch newest articles
`https://doaj.org/api/v2/search/articles/issn:${journalIdentifier}?sort=created_date:desc&page=${page}&pageSize=${pageSize}`;

// journalIdentifier: the pISSN or eISSN of the journal to search articles for
// page: the result page of the response (DOAJ returns pages containing a fixed number of articles)
// pageSize: the number of articles on a single response page
```

We use this endpoint to get journals:

```ts
// Search for journals
`https://doaj.org/api/v2/search/journals/${term}`;

// term: the search term (e.g. Biology, the eISSN of the journal, ...)
```

#### JournalTOCs Website

We use the [JournalTOCs][jt] website to download covers instead of an API. This means that we have to request the entire page and cut out the cover image. This happens in the [External Data Service](#external-data-service) in `src/collectors/cover.collector.ts`.

The following URL is used to get the correct website to the requested journal:

```ts
// URL to JournalTOCs
`http://www.journaltocs.ac.uk/index.php?action=tocs&issn=${journalIdentifier}`;

// journalIdentifier: the pISSN or eISSN of the journal to search a cover for
```

## Maintenance

This section covers important tasks to keep the App running in production.

### Updating certificates

A valid TLS certificate for the [API Gateway](#api-gateway) must be issued again after some time passes. Please have a look at the **Configuration** section in the main `README.md` file for more information on how to configure the [API Gateway](#api-gateway) and on where to place the certificate file and private key.

### Troubleshooting

We depend on third-party services to download journals, articles and covers and on multiple third-party packages to implement features.
Since software changes with time, some problems might occur that prevent Vidijo from working correctly.

This section aims to provide entrypoints for fixing problems that are caused by changing third-party software.

#### Downloading Journals and Articles

Journals are downloaded via the [DOAJ][doaj] API. If you tried to search for new journals to add to Vidijo and did not get any results, there might be something wrong with [DOAJ][doaj].

During development of Vidijo, [DOAJ][doaj] introduced a new version of its API (v2) that changed the way responses were structured. Instead of keeping the old API version as is, they redirected v1 requests to the new version. Since the structure of v1 is different to v2, our functions had to be changed to successfully fetch journals and articles again.

If this happens again in the future, you can apply the following steps to fix the problem:

1. Check out the changes of the API on the [DOAJ][doaj] website
2. Pick the pISSN or eISSN of a journal and call the new API endpoints (read section [DOAJ API](#doaj-api) for an overview on how the API is currently being used). In our case, I tried `https://doaj.org/api/v2/search/articles/issn:1726-4189?sort=created_date:desc&page=1&pageSize=1` to get a result page with one article of the journal "Biogeosciences" (sorted from newest to oldest)
3. Open the `article.collector.ts` that contains the methods to retrieve articles or `journal.collector.ts` if something is wrong with searching or adding journals
4. The method that contains the URL to the API endpoint is the one you have to change
5. In this method there is a section where retrieved journals are converted to the Vidijo format (annotated by a comment).
   It might look like the code listing below. In this part of the code you have to assign the correct values of the [DOAJ][doaj] API response to the matching fields of our own format. For example, our `title` is assigned to `doajArticle.bibjson.title`. If the [DOAJ][doaj] team decides to move the article title to a new location, `doajArticle.bibjson.title` returns no or a wrong value. Let's say they moved it to `bibjson.articleTitle`; then the line `title: doajArticle.bibjson.title || undefined,` must be changed to `title: doajArticle.bibjson.articleTitle ?? undefined,`

```ts
// Converting DOAJ article to Vidijo article
const article = {
  doi:
    doajArticle.bibjson.identifier.find((v) => v.type === "doi")?.id ||
    undefined,
  publishedIn: journalId,
  title: doajArticle.bibjson.title || undefined,
  authors: doajArticle.bibjson.author.map((v) => v.name) || undefined,
  abstract: doajArticle.bibjson.abstract || undefined,
  pubdate: new Date(doajArticle.created_date) || undefined,
} as IArticle;
```

Reassigning the correct response values to the matching fields of our own article and journal format should fix the problem.

#### Automatic Cover Download

The [External Data Service](#external-data-service) tries to automatically find a cover for newly added journals. We use the [JournalTOCs][jt] website for that.

Since our backend downloads the entire HTML of the page and cuts out the journal cover, this method only works as long as the [JournalTOCs][jt] website structure stays the same. If they update their layout or change some element IDs, the automatic cover download might not work anymore.

To fix this problem, open the file `src/collectors/cover.collector.ts` in the [External Data Service](#external-data-service). The method `searchCoverUrl` is the one that must be adjusted.

This is the part of the code that extracts the cover from the HTML:

```ts
// Extract the cover src from the HTML
(html) =>
  html
    .getElementById("column2Large")
    .getElementsByTagName("img")[0]
    .getAttribute("src") as string;
```

Pick a journal pISSN or eISSN and visit the [JournalTOCs][jt] website. Currently, this URL works: `http://www.journaltocs.ac.uk/index.php?action=tocs&issn=1726-4189`. Have a look at the page source in your browser and find the image that displays the journal cover.

Now you have to adjust the above listed part of the code to get to this image and return the `src` attribute as a string.

The current implementation works because the website has a `div` with ID `column2Large` that contains a single image - the cover image. We start by selecting this `div` using `.getElementById("column2Large")` and continue by selecting the cover image using `.getElementsByTagName("img")[0]` (select the first - and only - element with this tag name with `[0]`). After that, we use `.getAttribute("src") as string;` to get the `src` attribute and cast it to a string.

Depending on how [JournalTOCs][jt] decides to restructure their website, you have to find a way on how to reliably select the cover image every time.

#### Third-Party Software

After a few years, some versions of third-party packages might become unavailable. In that case, you can try to update the dependencies to their newest minor versions using the utility script `/util/update-dependencies.sh` (e.g. version 1.8.2 to 1.9.0). Check out the [SemVer][semver] specification for more information about major, minor and patch releases.

You should only update the packages to a new major version (e.g. from 2.7.9 to 3.0.1) if **absolutely necessary**! Since major releases contain breaking code changes, this might lead to breaking the entire app and having to rewrite bigger parts of it!

If the current LTS versions of [Node.js][node] become unsupported, you can try changing the node image in all Dockerfiles (e.g. change `FROM node:14` to `FROM node:16`). Please make sure that the currently used version of Angular supports this version of [Node.js][node] and that [Express][express] also supports this version.

[mean]: https://en.wikipedia.org/wiki/MEAN_(solution_stack)
[ts]: https://www.typescriptlang.org/
[ng]: https://angular.io/
[ng-mat]: https://material.angular.io/
[mongo]: https://www.mongodb.com/
[express]: https://expressjs.com/
[express-app]: http://expressjs.com/en/5x/api.html#app
[nginx]: https://www.nginx.com/
[docker]: https://www.docker.com/
[docker-bridge]: https://docs.docker.com/network/bridge/
[dockerfile]: https://docs.docker.com/engine/reference/builder/
[doaj]: https://doaj.org/
[jt]: http://www.journaltocs.ac.uk/
[prettier]: https://prettier.io/
[gulp]: https://gulpjs.com/
[package-lock]: https://docs.npmjs.com/cli/v6/configuring-npm/package-lock-json
[package]: https://docs.npmjs.com/cli/v6/configuring-npm/package-json
[semver]: https://semver.org/lang/de/
[node]: https://nodejs.org/en/docs/
